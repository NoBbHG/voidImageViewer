name: build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y

      - name: Add NSIS to PATH (and verify)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "C:\Program Files (x86)\NSIS",
            "C:\Program Files\NSIS",
            "C:\tools\nsis",
            "C:\ProgramData\chocolatey\lib\nsis\tools"
          )

          $nsisDir = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $nsisDir) {
            $mk = Get-ChildItem -Path "C:\" -Recurse -ErrorAction SilentlyContinue -Filter makensis.exe | Select-Object -First 1
            if ($mk) { $nsisDir = $mk.Directory.FullName }
          }

          if (-not $nsisDir) { throw "NSIS installed but could not find makensis.exe" }

          Write-Host "NSIS dir: $nsisDir"
          "PATH=$nsisDir;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          & (Join-Path $nsisDir "makensis.exe") /VERSION

      - name: Locate solution (prefer vs2026/vs2019)
        id: locate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            (Join-Path $pwd "vs2026\voidImageViewer.sln"),
            (Join-Path $pwd "vs2019\voidImageViewer.sln"),
            (Join-Path $pwd "voidImageViewer.sln")
          )

          $sln = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sln) {
            $found = Get-ChildItem -Recurse -Filter *.sln |
              Where-Object { $_.FullName -notmatch '\\vs2005\\' } |
              Select-Object -First 1
            if ($found) { $sln = $found.FullName }
          }

          if (-not $sln) { throw "No .sln found in repo." }

          Write-Host "Using solution: $sln"
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Retarget toolset v145 -> v143 (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $files = Get-ChildItem -Recurse -Include *.vcxproj,*.props,*.targets
          $hit = 0

          foreach ($f in $files) {
            $text = Get-Content $f.FullName -Raw
            if ($text -match '<PlatformToolset>\s*v145\s*</PlatformToolset>') {
              $new = $text -replace '<PlatformToolset>\s*v145\s*</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
              Set-Content -Path $f.FullName -Value $new -Encoding utf8
              Write-Host "Retargeted: $($f.FullName)"
              $hit++
            }
          }

          Write-Host "Retargeted file count: $hit"

      - name: Build x64 Release
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "MSBuild x64..."
          msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=x64 /verbosity:minimal

      - name: Build Win32 Release
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "MSBuild Win32..."
          msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=Win32 /verbosity:minimal

      - name: Generate nsis\version.nsh (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "Generating nsis\version.nsh ..."

          $tag = (git describe --tags --abbrev=0 2>$null)
          if (-not $tag) { $tag = "0.0.0.0" }
          $tag = $tag.Trim()
          if ($tag.StartsWith("v")) { $tag = $tag.Substring(1) }

          $parts = $tag.Split(".") | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
          while ($parts.Count -lt 4) { $parts += "0" }

          $maj = [int]$parts[0]
          $min = [int]$parts[1]
          $pat = [int]$parts[2]
          $bld = [int]$parts[3]

          $ver4 = "$maj.$min.$pat.$bld"
          Write-Host "NSIS version: $ver4"

          $nsisDir = Join-Path $pwd "nsis"
          if (-not (Test-Path $nsisDir)) { throw "nsis directory not found" }

          $out = Join-Path $nsisDir "version.nsh"

          $lines = @(
            "; Auto-generated by GitHub Actions",
            "!define VIV_VERSION `"$ver4`"",
            "!define VERSION `"$ver4`"",
            "!define APP_VERSION `"$ver4`"",
            "!define PRODUCT_VERSION `"$ver4`"",
            "!define FILE_VERSION `"$ver4`"",
            "",
            "!define VER_MAJOR $maj",
            "!define VER_MINOR $min",
            "!define VER_PATCH $pat",
            "!define VER_BUILD $bld",
            "",
            "; Common alternates some scripts use",
            "!define VER_REV $pat",
            "!define VER_REVISION $pat"
          )

          Set-Content -Path $out -Value $lines -Encoding utf8
          Write-Host "Wrote: $out"
          Get-Content $out

      - name: Build installer (NSIS)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $nsi = Join-Path $pwd "nsis\installer.nsi"
          if (-not (Test-Path $nsi)) { throw "NSIS script not found: $nsi" }

          $mk = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe",
            "C:\tools\nsis\makensis.exe",
            "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $mk) {
            $cmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($cmd) { $mk = $cmd.Source }
          }
          if (-not $mk) { throw "makensis.exe not found" }

          Write-Host "Using makensis: $mk"
          & $mk /V2 /I (Join-Path $pwd "nsis") "$nsi"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-build
          if-no-files-found: warn
          path: |
            **\Release\*.exe
            **\Release\*.dll
            **\Release\*.pdb
            **\nsis\*.exe
            **\*.exe
            **\*.zip
            **\*.msi
