name: Build voidImageViewer (with language patch)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-2019
    timeout-minutes: 60

    strategy:
      matrix:
        platform: [Win32, x64]
        configuration: [Release]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 创建 language.c 补丁文件
        shell: pwsh
        run: |
          Write-Host "创建 language.c 补丁文件以解决链接错误..."
          
          $languageC = @'
          // Temporary language.c stub for GitHub Actions build
          // This file provides empty implementations to resolve linker errors
          
          #include <windows.h>
          
          // Stub: Return empty string for all language requests
          const wchar_t* language_get_string(int string_id)
          {
              return L"";
          }
          
          // Stub: Do nothing for language initialization
          void language_init(void)
          {
              // Language support disabled in this build
          }
          '@
          
          $srcDir = "src"
          if (-not (Test-Path $srcDir)) {
              throw "src 目录不存在"
          }
          
          $languagePath = Join-Path $srcDir "language.c"
          Set-Content -Path $languagePath -Value $languageC -Encoding UTF8
          Write-Host "已创建: $languagePath"
          
          # 同时创建 language.h 头文件
          $languageH = @'
          // language.h - stub header
          #ifndef LANGUAGE_H
          #define LANGUAGE_H
          
          const wchar_t* language_get_string(int string_id);
          void language_init(void);
          
          #endif
          '@
          
          $headerPath = Join-Path $srcDir "language.h"
          Set-Content -Path $headerPath -Value $languageH -Encoding UTF8
          Write-Host "已创建: $headerPath"

      - name: 将 language.c 添加到项目
        shell: pwsh
        run: |
          Write-Host "将 language.c 添加到 vcxproj..."
          
          # 查找 .vcxproj 文件
          $vcxproj = Get-ChildItem -Recurse -Filter "voidImageViewer.vcxproj" | Select-Object -First 1
          
          if (-not $vcxproj) {
              Write-Host "警告: 未找到 vcxproj 文件，跳过此步骤"
              exit 0
          }
          
          Write-Host "找到项目文件: $($vcxproj.FullName)"
          
          # 读取项目文件
          $content = Get-Content $vcxproj.FullName -Raw -Encoding UTF8
          
          # 检查是否已包含 language.c
          if ($content -match 'language\.c') {
              Write-Host "language.c 已在项目中"
              exit 0
          }
          
          # 查找 <ClCompile> 部分并添加 language.c
          if ($content -match '(<ItemGroup>[\s\S]*?<ClCompile Include="[^"]+\.c"[^>]*/>[\s\S]*?</ItemGroup>)') {
              $itemGroup = $matches[1]
              $newItemGroup = $itemGroup -replace '(</ItemGroup>)', '    <ClCompile Include="..\src\language.c" />`r`n  $1'
              $content = $content -replace [regex]::Escape($itemGroup), $newItemGroup
              
              Set-Content -Path $vcxproj.FullName -Value $content -Encoding UTF8
              Write-Host "已将 language.c 添加到项目文件"
          } else {
              Write-Host "警告: 无法找到合适的位置添加文件"
          }

      - name: 设置 MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: 定位解决方案文件
        id: locate-sln
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $candidates = @(
            "vs2019\voidImageViewer.sln",
            "vs2005\voidImageViewer.sln",
            "voidImageViewer.sln"
          )
          
          $sln = $null
          foreach ($c in $candidates) {
            if (Test-Path $c) {
              $sln = $c
              Write-Host "找到解决方案: $sln"
              break
            }
          }
          
          if (-not $sln) {
            throw "未找到解决方案文件"
          }
          
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 编译项目
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $sln = "${{ steps.locate-sln.outputs.sln }}"
          $platform = "${{ matrix.platform }}"
          $config = "${{ matrix.configuration }}"
          
          Write-Host "编译: $sln"
          Write-Host "平台: $platform"
          Write-Host "配置: $config"
          
          msbuild "$sln" /m /p:Configuration=$config /p:Platform=$platform /v:minimal /t:Rebuild
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "编译失败，尝试清理后重新编译..."
            msbuild "$sln" /t:Clean /p:Configuration=$config /p:Platform=$platform
            msbuild "$sln" /m /p:Configuration=$config /p:Platform=$platform /v:detailed
            
            if ($LASTEXITCODE -ne 0) {
              throw "编译失败，退出码: $LASTEXITCODE"
            }
          }
          
          Write-Host "编译成功！"

      - name: 查找并收集编译输出
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          New-Item -ItemType Directory -Force -Path "output" | Out-Null
          
          $searchPaths = @(
            "vs2019\${{ matrix.platform }}\${{ matrix.configuration }}\*.exe",
            "vs2019\${{ matrix.platform }}\${{ matrix.configuration }}\*.dll",
            "vs2005\${{ matrix.configuration }}\*.exe",
            "vs2005\${{ matrix.configuration }}\*.dll",
            "${{ matrix.configuration }}\*.exe",
            "${{ matrix.configuration }}\*.dll"
          )
          
          $foundFiles = $false
          foreach ($path in $searchPaths) {
            $files = Get-ChildItem -Path $path -ErrorAction SilentlyContinue
            if ($files) {
              foreach ($file in $files) {
                Copy-Item $file.FullName "output\" -Force
                Write-Host "已复制: $($file.Name) ($([math]::Round($file.Length/1KB, 2)) KB)"
                $foundFiles = $true
              }
            }
          }
          
          if (-not $foundFiles) {
            Write-Host "警告: 未找到编译输出文件"
            Write-Host "搜索所有 .exe 文件:"
            Get-ChildItem -Recurse -Filter "*.exe" | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          }
          
          Write-Host ""
          Write-Host "输出目录内容:"
          Get-ChildItem "output" -ErrorAction SilentlyContinue | Format-Table Name, Length

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-${{ matrix.platform }}-${{ matrix.configuration }}-patched
          path: output/
          if-no-files-found: warn

      - name: 创建说明文件
        shell: pwsh
        run: |
          $readme = @"
          voidImageViewer - GitHub Actions 构建版本
          
          构建信息:
          - 平台: ${{ matrix.platform }}
          - 配置: ${{ matrix.configuration }}
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 构建编号: ${{ github.run_number }}
          
          注意事项:
          本版本使用了 language.c 补丁文件来解决链接错误。
          这意味着：
          1. 所有语言/本地化功能已被禁用
          2. 部分菜单文本可能为空或显示异常
          3. 核心图片查看功能应该正常工作
          
          如需完整功能版本，请访问:
          https://github.com/voidtools/voidImageViewer/releases
          
          源代码:
          https://github.com/voidtools/voidImageViewer
          "@
          
          Set-Content -Path "output\README.txt" -Value $readme -Encoding UTF8
          Write-Host "已创建说明文件"
