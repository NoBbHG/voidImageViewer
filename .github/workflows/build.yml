name: build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NSIS
        run: choco install nsis -y

      - name: Locate solution (prefer vs2026/vs2019)
        id: locate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Prefer modern VS solutions if present
          $candidates = @(
            "vs2026\voidImageViewer.sln",
            "vs2019\voidImageViewer.sln",
            "voidImageViewer.sln"
          ) | ForEach-Object { Join-Path $pwd $_ }

          $sln = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sln) {
            # fallback: pick any .sln but avoid legacy vs2005
            $found = Get-ChildItem -Recurse -Filter *.sln |
              Where-Object { $_.FullName -notmatch '\\vs2005\\' } |
              Select-Object -First 1

            if ($found) { $sln = $found.FullName }
          }

          if (-not $sln) { throw "No .sln found in repo." }

          Write-Host "Using solution: $sln"
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          # Diagnostics: confirm file is readable and not empty/garbled
          Get-Item $sln | Format-List FullName,Length,LastWriteTime
          Write-Host "First 10 lines of solution:"
          Get-Content $sln -TotalCount 10

      - name: Build x64 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=x64

      - name: Build Win32 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=Win32

      - name: Build installer (NSIS)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"

          $nsi1 = Join-Path $pwd "nsis\installer.nsi"
          $nsi2 = Join-Path $pwd "nsis\voidImageViewer.nsi"

          $nsi = $null
          if (Test-Path $nsi1) { $nsi = $nsi1 }
          elseif (Test-Path $nsi2) { $nsi = $nsi2 }
          else {
            $maybe = Get-ChildItem -Recurse -Filter *.nsi | Select-Object -First 1
            if ($maybe) { $nsi = $maybe.FullName }
          }

          if ($nsi) {
            Write-Host "Running NSIS: $nsi"
            & makensis $nsi
            if ($LASTEXITCODE -ne 0) { throw "makensis failed with exit code $LASTEXITCODE" }
          } else {
            Write-Host "No .nsi found. Skipping installer step."
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-build
          if-no-files-found: warn
          path: |
            **\Release\*.exe
            **\Release\*.dll
            **\Release\*.pdb
            **\*.exe
            **\*.zip
            **\*.msi
