name: build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y

      - name: Add NSIS to PATH (and verify)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "C:\Program Files (x86)\NSIS",
            "C:\Program Files\NSIS",
            "C:\tools\nsis",
            "C:\ProgramData\chocolatey\lib\nsis\tools"
          )

          $nsisDir = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $nsisDir) {
            $mk = Get-ChildItem -Path "C:\" -Recurse -ErrorAction SilentlyContinue -Filter makensis.exe |
              Select-Object -First 1
            if ($mk) { $nsisDir = $mk.Directory.FullName }
          }

          if (-not $nsisDir) { throw "NSIS installed but could not find makensis.exe" }

          Write-Host "NSIS dir: $nsisDir"
          "PATH=$nsisDir;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          & (Join-Path $nsisDir "makensis.exe") /VERSION

      - name: Locate solution (prefer vs2026/vs2019)
        id: locate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "vs2026\voidImageViewer.sln",
            "vs2019\voidImageViewer.sln",
            "voidImageViewer.sln"
          ) | ForEach-Object { Join-Path $pwd $_ }

          $sln = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sln) {
            $found = Get-ChildItem -Recurse -Filter *.sln |
              Where-Object { $_.FullName -notmatch '\\vs2005\\' } |
              Select-Object -First 1
            if ($found) { $sln = $found.FullName }
          }

          if (-not $sln) { throw "No .sln found in repo." }

          Write-Host "Using solution: $sln"
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Retarget toolset v145 -> v143 (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $files = Get-ChildItem -Recurse -Include *.vcxproj,*.props,*.targets
          $hit = 0
          foreach ($f in $files) {
            $text = Get-Content $f.FullName -Raw
            if ($text -match '<PlatformToolset>\s*v145\s*</PlatformToolset>') {
              $new = $text -replace '<PlatformToolset>\s*v145\s*</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
              Set-Content -Path $f.FullName -Value $new -Encoding utf8
              Write-Host "Retargeted: $($f.FullName)"
              $hit++
            }
          }
          if ($hit -eq 0) { Write-Host "No v145 toolset references found to retarget." }

      - name: Build x64 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=x64

      - name: Build Win32 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=Win32

      - name: Generate nsis\version.nsh (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Get version from latest tag (fallback to 0.0.0.0)
          $tag = (git describe --tags --abbrev=0 2>$null)
          if (-not $tag) { $tag = "0.0.0.0" }
          $tag = $tag.Trim()
          if ($tag.StartsWith("v")) { $tag = $tag.Substring(1) }

          $parts = $tag.Split(".") | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
          while ($parts.Count -lt 4) { $parts += "0" }

          $maj = [int]$parts[0]
          $min = [int]$parts[1]
          $pat = [int]$parts[2]
          $bld = [int]$parts[3]

          $ver4 = "$maj.$min.$pat.$bld"
          Write-Host "NSIS version: $ver4"

          $nsisDir = Join-Path $pwd "nsis"
          if (-not (Test-Path $nsisDir)) { throw "nsis directory not found" }

          $out = Join-Path $nsisDir "version.nsh"

          @"
; Auto-generated by GitHub Actions
!define VIV_VERSION "$ver4"
!define VERSION "$ver4"
!define APP_VERSION "$ver4"
!define PRODUCT_VERSION "$ver4"
!define FILE_VERSION "$ver4"

!define VER_MAJOR $maj
!define VER_MINOR $min
!define VER_PATCH $pat
!define VER_BUILD $bld

; Common alternates some scripts use
!define VER_REV $pat
!define VER_REVISION $pat
"@ | Set-Content -Path $out -Encoding utf8

          Write-Host "Wrote: $out"
          Get-Content $out

      - name: Build installer (NSIS)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $nsi1 = Join-Path $pwd "nsis\installer.nsi"
          $nsi2 = Join-Path $pwd "nsis\voidImageViewer.nsi"

          $nsi = $null
          if (Test-Path $nsi1) { $nsi = $nsi1 }
          elseif (Test-Path $nsi2) { $nsi = $nsi2 }
          else {
            $maybe = Get-ChildItem -Recurse -Filter *.nsi | Select-Object -First 1
            if ($maybe) { $nsi = $maybe.FullName }
          }

          if (-not $nsi) {
            Write-Host "No .nsi found. Skipping installer step."
            exit 0
          }

          $mk = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe",
            "C:\tools\nsis\makensis.exe",
            "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $mk) {
            $cmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($cmd) { $mk = $cmd.Source }
          }

          if (-not $mk) { throw "makensis.exe not found on PATH or known locations" }

          Write-Host "Using makensis: $mk"
          Write-Host "Running NSIS: $nsi"

          # IMPORTANT: add nsis dir to include search path so !include "version.nsh" works
          & $mk /V2 /I "$pwd\nsis" "$nsi"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-build
          if-no-files-found: warn
          path: |
            **\Release\*.exe
            **\Release\*.dll
            **\Release\*.pdb
            **\nsis\*.exe
            **\*.exe
            **\*.zip
            **\*.msi
