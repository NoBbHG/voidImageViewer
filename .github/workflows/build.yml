name: build

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  windows:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y

      - name: Add NSIS to PATH (and verify)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "C:\Program Files (x86)\NSIS",
            "C:\Program Files\NSIS",
            "C:\tools\nsis",
            "C:\ProgramData\chocolatey\lib\nsis\tools"
          )

          $nsisDir = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $nsisDir) {
            $mk = Get-ChildItem -Path "C:\" -Recurse -ErrorAction SilentlyContinue -Filter makensis.exe | Select-Object -First 1
            if ($mk) { $nsisDir = $mk.Directory.FullName }
          }

          if (-not $nsisDir) { throw "NSIS installed but could not find makensis.exe" }

          Write-Host "NSIS dir: $nsisDir"
          "PATH=$nsisDir;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          & (Join-Path $nsisDir "makensis.exe") /VERSION

      - name: Locate solution (prefer vs2026/vs2019)
        id: locate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            (Join-Path $pwd "vs2026\voidImageViewer.sln"),
            (Join-Path $pwd "vs2019\voidImageViewer.sln"),
            (Join-Path $pwd "voidImageViewer.sln")
          )

          $sln = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sln) {
            $found = Get-ChildItem -Recurse -Filter *.sln |
              Where-Object { $_.FullName -notmatch '\\vs2005\\' } |
              Select-Object -First 1
            if ($found) { $sln = $found.FullName }
          }

          if (-not $sln) { throw "No .sln found in repo." }

          Write-Host "Using solution: $sln"
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Retarget toolset v145 -> v143 (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $files = Get-ChildItem -Recurse -Include *.vcxproj,*.props,*.targets
          foreach ($f in $files) {
            $text = Get-Content $f.FullName -Raw
            if ($text -match '<PlatformToolset>\s*v145\s*</PlatformToolset>') {
              $new = $text -replace '<PlatformToolset>\s*v145\s*</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
              Set-Content -Path $f.FullName -Value $new -Encoding utf8
              Write-Host "Retargeted: $($f.FullName)"
            }
          }

      - name: Generate nsis\version.nsh (CI, no git tags needed)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $maj = 0
          $min = 0
          $pat = 0
          $bld = [int]"${{ github.run_number }}"
          $ver4 = "$maj.$min.$pat.$bld"

          $nsisDir = Join-Path $pwd "nsis"
          if (-not (Test-Path $nsisDir)) { throw "nsis directory not found" }

          $out = Join-Path $nsisDir "version.nsh"

          $lines = @(
            "; Auto-generated by GitHub Actions",
            "!define VIV_VERSION `"$ver4`"",
            "!define VERSION `"$ver4`"",
            "!define APP_VERSION `"$ver4`"",
            "!define PRODUCT_VERSION `"$ver4`"",
            "!define FILE_VERSION `"$ver4`"",
            "",
            "!define VER_MAJOR $maj",
            "!define VER_MINOR $min",
            "!define VER_PATCH $pat",
            "!define VER_BUILD $bld",
            "",
            "; Common alternates some scripts use",
            "!define VER_REV $pat",
            "!define VER_REVISION $pat"
          )

          Set-Content -Path $out -Value $lines -Encoding utf8
          Write-Host "Wrote: $out"
          Get-Content $out

      - name: Build x64 Release
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=x64 /verbosity:minimal

      - name: Build installer (NSIS) via cmd.exe (stable argv)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $nsi = Join-Path $pwd "nsis\installer.nsi"
          if (-not (Test-Path $nsi)) { throw "NSIS script not found: $nsi" }

          $mk = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe",
            "C:\tools\nsis\makensis.exe",
            "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $mk) {
            $cmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($cmd) { $mk = $cmd.Source }
          }
          if (-not $mk) { throw "makensis.exe not found" }

          $includeDir = Join-Path $pwd "nsis"

          Write-Host "Using makensis: $mk"
          Write-Host "NSIS include dir: $includeDir"
          Write-Host "Running NSIS: $nsi"

          # IMPORTANT:
          # - use cmd.exe to avoid PowerShell/Win32 argv edge cases
          # - /I must be /I"<path>" (no space between /I and the quote)
          $cmdLine = """$mk"" /V2 /INPUTCHARSET UTF8 /I""$includeDir"" ""$nsi"""
          Write-Host "CMD: $cmdLine"
          cmd.exe /c $cmdLine

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-build
          if-no-files-found: warn
          path: |
            **\Release\*.exe
            **\Release\*.dll
            **\Release\*.pdb
            **\nsis\*.exe
            **\*.exe
            **\*.zip
            **\*.msi
