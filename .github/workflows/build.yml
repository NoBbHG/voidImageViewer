name: build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y

      - name: Add NSIS to PATH (and verify)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "C:\Program Files (x86)\NSIS",
            "C:\Program Files\NSIS",
            "C:\tools\nsis",
            "C:\ProgramData\chocolatey\lib\nsis\tools"
          )

          $nsisDir = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $nsisDir) {
            $mk = Get-ChildItem -Path "C:\" -Recurse -ErrorAction SilentlyContinue -Filter makensis.exe |
              Select-Object -First 1
            if ($mk) { $nsisDir = $mk.Directory.FullName }
          }

          if (-not $nsisDir) { throw "NSIS installed but could not find makensis.exe" }

          Write-Host "NSIS dir: $nsisDir"
          "PATH=$nsisDir;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          & (Join-Path $nsisDir "makensis.exe") /VERSION

      - name: Locate solution (prefer vs2026/vs2019)
        id: locate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidates = @(
            "vs2026\voidImageViewer.sln",
            "vs2019\voidImageViewer.sln",
            "voidImageViewer.sln"
          ) | ForEach-Object { Join-Path $pwd $_ }

          $sln = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sln) {
            $found = Get-ChildItem -Recurse -Filter *.sln |
              Where-Object { $_.FullName -notmatch '\\vs2005\\' } |
              Select-Object -First 1
            if ($found) { $sln = $found.FullName }
          }

          if (-not $sln) { throw "No .sln found in repo." }

          Write-Host "Using solution: $sln"
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          Get-Item $sln | Format-List FullName,Length,LastWriteTime
          Write-Host "First 10 lines of solution:"
          Get-Content $sln -TotalCount 10

      - name: Retarget toolset v145 -> v143 (CI)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $files = Get-ChildItem -Recurse -Include *.vcxproj,*.props,*.targets
          $hit = 0
          foreach ($f in $files) {
            $text = Get-Content $f.FullName -Raw
            if ($text -match '<PlatformToolset>\s*v145\s*</PlatformToolset>') {
              $new = $text -replace '<PlatformToolset>\s*v145\s*</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
              Set-Content -Path $f.FullName -Value $new -Encoding utf8
              Write-Host "Retargeted: $($f.FullName)"
              $hit++
            }
          }
          if ($hit -eq 0) { Write-Host "No v145 toolset references found to retarget." }

      - name: Build x64 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=x64

      - name: Build Win32 Release
        run: msbuild "${{ steps.locate.outputs.sln }}" /m /p:Configuration=Release /p:Platform=Win32

      - name: Build installer (NSIS)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $nsi1 = Join-Path $pwd "nsis\installer.nsi"
          $nsi2 = Join-Path $pwd "nsis\voidImageViewer.nsi"

          $nsi = $null
          if (Test-Path $nsi1) { $nsi = $nsi1 }
          elseif (Test-Path $nsi2) { $nsi = $nsi2 }
          else {
            $maybe = Get-ChildItem -Recurse -Filter *.nsi | Select-Object -First 1
            if ($maybe) { $nsi = $maybe.FullName }
          }

          if (-not $nsi) {
            Write-Host "No .nsi found. Skipping installer step."
            exit 0
          }

          $mk = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe",
            "C:\tools\nsis\makensis.exe",
            "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $mk) {
            $cmd = Get-Command makensis -ErrorAction SilentlyContinue
            if ($cmd) { $mk = $cmd.Source }
          }

          if (-not $mk) { throw "makensis.exe not found on PATH or known locations" }

          Write-Host "Using makensis: $mk"
          Write-Host "Running NSIS: $nsi"
          & $mk $nsi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-build
          if-no-files-found: warn
          path: |
            **\Release\*.exe
            **\Release\*.dll
            **\Release\*.pdb
            **\*.exe
            **\*.zip
            **\*.msi
