name: Build voidImageViewer (Patch Source)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-2019
    timeout-minutes: 60

    strategy:
      matrix:
        platform: [Win32, x64]
        configuration: [Release]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 修补源代码 - 移除 language 调用
        shell: pwsh
        run: |
          Write-Host "修补 viv.c 以移除 language 函数调用..."
          
          $vivPath = "src\viv.c"
          
          if (-not (Test-Path $vivPath)) {
              throw "找不到 src\viv.c"
          }
          
          $content = Get-Content $vivPath -Raw -Encoding UTF8
          
          Copy-Item $vivPath "$vivPath.backup"
          Write-Host "已备份原文件"
          
          $content = $content -replace 'language_init\s*\(\s*\)\s*;', '// language_init(); // Disabled for GitHub Actions build'
          
          $content = $content -replace 'language_get_string\s*\([^)]+\)', 'L""'
          
          $content = $content -replace '#include\s+[<"]language\.h[>"]', '// #include "language.h" // Disabled'
          
          Set-Content -Path $vivPath -Value $content -Encoding UTF8
          
          Write-Host "源代码修补完成"
          Write-Host "修改统计:"
          Write-Host "  - 已注释 language_init() 调用"
          Write-Host "  - 已替换 language_get_string() 为空字符串"
          Write-Host "  - 已注释 language.h 引用"

      - name: 检查修补结果
        shell: pwsh
        run: |
          Write-Host "检查修补后的代码..."
          
          $vivPath = "src\viv.c"
          $content = Get-Content $vivPath -Raw
          
          if ($content -match 'language_get_string\s*\(') {
              Write-Host "警告: 仍有 language_get_string 调用未处理"
          } else {
              Write-Host "OK - 所有 language_get_string 调用已处理"
          }
          
          if ($content -match 'language_init\s*\(') {
              Write-Host "警告: 仍有 language_init 调用未处理"
          } else {
              Write-Host "OK - 所有 language_init 调用已处理"
          }

      - name: 设置 MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: 定位解决方案文件
        id: locate-sln
        shell: pwsh
        run: |
          $candidates = @(
            "vs2019\voidImageViewer.sln",
            "vs2005\voidImageViewer.sln",
            "voidImageViewer.sln"
          )
          
          $sln = $null
          foreach ($c in $candidates) {
            if (Test-Path $c) {
              $sln = $c
              Write-Host "找到解决方案: $sln"
              break
            }
          }
          
          if (-not $sln) {
            throw "未找到解决方案文件"
          }
          
          "sln=$sln" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 编译项目
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $sln = "${{ steps.locate-sln.outputs.sln }}"
          $platform = "${{ matrix.platform }}"
          $config = "${{ matrix.configuration }}"
          
          Write-Host "========================================="
          Write-Host "开始编译"
          Write-Host "========================================="
          Write-Host "解决方案: $sln"
          Write-Host "平台: $platform"
          Write-Host "配置: $config"
          Write-Host "========================================="
          
          msbuild "$sln" /m /p:Configuration=$config /p:Platform=$platform /v:minimal /t:Rebuild
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "========================================="
            Write-Host "编译失败，退出码: $LASTEXITCODE"
            Write-Host "========================================="
            throw "编译失败"
          }
          
          Write-Host "========================================="
          Write-Host "编译成功！"
          Write-Host "========================================="

      - name: 查找并收集编译输出
        shell: pwsh
        run: |
          Write-Host "收集编译输出..."
          
          New-Item -ItemType Directory -Force -Path "output" | Out-Null
          
          $searchPaths = @(
            "vs2019\${{ matrix.platform }}\${{ matrix.configuration }}",
            "vs2005\${{ matrix.configuration }}",
            "${{ matrix.configuration }}"
          )
          
          $foundFiles = $false
          foreach ($basePath in $searchPaths) {
            if (Test-Path $basePath) {
              Write-Host "检查目录: $basePath"
              
              $exeFiles = @(Get-ChildItem -Path $basePath -Filter "*.exe" -ErrorAction SilentlyContinue)
              $dllFiles = @(Get-ChildItem -Path $basePath -Filter "*.dll" -ErrorAction SilentlyContinue)
              
              $allFiles = $exeFiles + $dllFiles
              
              foreach ($file in $allFiles) {
                Copy-Item $file.FullName "output\" -Force
                $sizeKB = [math]::Round($file.Length/1KB, 2)
                Write-Host "  OK - 已复制: $($file.Name) ($sizeKB KB)"
                $foundFiles = $true
              }
            }
          }
          
          if (-not $foundFiles) {
            Write-Host "警告: 未找到编译输出文件"
            Write-Host "搜索所有 .exe 文件:"
            Get-ChildItem -Recurse -Filter "*.exe" | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          } else {
            Write-Host ""
            Write-Host "输出目录内容:"
            Get-ChildItem "output" | ForEach-Object {
              $sizeKB = [math]::Round($_.Length/1KB, 2)
              Write-Host "  $($_.Name) - $sizeKB KB"
            }
          }

      - name: 创建说明文件
        shell: pwsh
        run: |
          $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          $readme = "voidImageViewer - GitHub Actions Build`n"
          $readme += "`n"
          $readme += "Platform: ${{ matrix.platform }}`n"
          $readme += "Configuration: ${{ matrix.configuration }}`n"
          $readme += "Build Time: $buildTime`n"
          $readme += "Build Number: ${{ github.run_number }}`n"
          $readme += "Commit: ${{ github.sha }}`n"
          $readme += "`n"
          $readme += "Note: This build has language functions disabled.`n"
          $readme += "Some menu text may be empty.`n"
          $readme += "`n"
          $readme += "For official builds visit:`n"
          $readme += "https://github.com/voidtools/voidImageViewer/releases`n"
          
          Set-Content -Path "output\README.txt" -Value $readme -Encoding UTF8
          Write-Host "已创建说明文件"

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: voidImageViewer-${{ matrix.platform }}-${{ matrix.configuration }}-patched
          path: output/
          if-no-files-found: warn

      - name: 上传修改后的源代码
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: patched-source-${{ matrix.platform }}
          path: |
            src/viv.c
            src/viv.c.backup
          if-no-files-found: warn
